# LifeBit 프로젝트 배포 가이드

## 📋 목차
1. [사전 준비사항](#사전-준비사항)
2. [프로젝트 클론 및 설정](#프로젝트-클론-및-설정)
3. [도메인 구매 및 DNS 설정](#도메인-구매-및-dns-설정)
4. [AWS 계정 설정](#aws-계정-설정)
5. [환경변수 설정](#환경변수-설정)
6. [배포 실행](#배포-실행)
7. [배포 확인](#배포-확인)
8. [문제 해결](#문제-해결)
9. [리소스 정리](#리소스-정리)

---

## 🛠️ 사전 준비사항

배포를 시작하기 전에 다음 도구들이 설치되어 있어야 합니다:

### 필수 도구 설치

```bash
# 1. Git 설치 확인
git --version

# 2. Docker 설치 확인
docker --version
docker-compose --version

# 3. Terraform 설치 확인
terraform --version

# 4. Ansible 설치 확인
ansible --version

# 5. AWS CLI 설치 확인
aws --version
```

### 도구 설치가 필요한 경우

**Ubuntu/Debian:**
```bash
# Docker 설치
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Terraform 설치
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform

# Ansible 설치
sudo apt update
sudo apt install ansible

# AWS CLI 설치
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

**macOS:**
```bash
# Homebrew 사용
brew install docker terraform ansible awscli
```

---

## 📂 프로젝트 클론 및 설정

### 1. 프로젝트 클론
```bash
git clone <LifeBit-Repository-URL>
cd LifeBit
```

### 2. 프로젝트 구조 확인
```bash
tree -L 2
```

예상 출력:
```
LifeBit/
├── apps/
├── docs/
├── infrastructure/
├── scripts/
├── .env.example
├── docker-compose.local.yml
├── docker-compose.prod.yml
└── README.md
```

---

## 🌐 도메인 구매 및 DNS 설정

### 1. 가비아에서 도메인 구매

1. **가비아 웹사이트 접속**
   - https://www.gabia.com 접속
   - 회원가입 및 로그인

2. **도메인 검색 및 구매**
   - 원하는 도메인명 검색 (예: `mylifebit.store`)
   - 도메인 선택 후 결제 진행
   - 구매 완료 후 "My 가비아" → "도메인 관리" 확인

### 2. DNS 설정 (중요!)

⚠️ **주의**: DNS 설정은 배포 완료 후에 진행합니다. 먼저 AWS 서버 IP를 확보해야 합니다.

**DNS 설정 순서:**
1. AWS 배포 완료 → 서버 IP 확보
2. 가비아에서 DNS 레코드 설정
3. DNS 전파 대기 (5-30분)
4. 도메인 접속 확인

---

## ☁️ AWS 계정 설정

### 1. AWS 계정 생성
- https://aws.amazon.com 에서 계정 생성
- 신용카드 등록 (프리티어 사용 가능)

### 2. IAM 사용자 생성 및 권한 설정

1. **IAM 콘솔 접속**
   - AWS 콘솔 → IAM 서비스 선택

2. **새 사용자 생성**
   - "사용자" → "사용자 추가"
   - 사용자 이름: `lifebit-deployer`
   - 액세스 유형: "프로그래밍 방식 액세스" 선택

3. **권한 설정**
   - "기존 정책 직접 연결"
   - 다음 정책들 선택:
     - `AmazonEC2FullAccess`
     - `AmazonVPCFullAccess`
     - `IAMFullAccess`

4. **액세스 키 저장**
   - Access Key ID와 Secret Access Key를 안전하게 저장
   - ⚠️ 이 정보는 다시 확인할 수 없으니 반드시 저장!

### 3. AWS CLI 설정
```bash
aws configure
```

입력 정보:
```
AWS Access Key ID: [위에서 생성한 Access Key ID]
AWS Secret Access Key: [위에서 생성한 Secret Access Key]
Default region name: ap-northeast-2
Default output format: json
```

### 4. AWS 설정 확인
```bash
aws sts get-caller-identity
```

---

## ⚙️ 환경변수 설정

### 1. 환경변수 파일 생성
```bash
cp .env.example .env
```

### 2. `.env` 파일 편집

```bash
nano .env
# 또는
vim .env
```

### 3. 필수 설정 항목

```env
# 🌐 도메인 설정 (가장 중요!)
DOMAIN_NAME=mylifebit.store  # 구매한 도메인명으로 변경

# 🔐 데이터베이스 설정
POSTGRES_DB=lifebit
POSTGRES_USER=lifebit_user
POSTGRES_PASSWORD=your_secure_password_here  # 강력한 비밀번호로 변경

# 🔑 JWT 설정
JWT_SECRET=your_jwt_secret_key_here  # 랜덤한 긴 문자열로 변경
JWT_EXPIRATION=86400

# 🤖 OpenAI API 설정 (선택사항)
OPENAI_API_KEY=your_openai_api_key_here  # OpenAI API 키

# 📧 이메일 설정 (SSL 인증서용)
ADMIN_EMAIL=your-email@example.com  # 실제 이메일 주소

# 🔐 소셜 로그인 설정 (선택사항)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
KAKAO_CLIENT_ID=your_kakao_client_id
KAKAO_CLIENT_SECRET=your_kakao_client_secret
NAVER_CLIENT_ID=your_naver_client_id
NAVER_CLIENT_SECRET=your_naver_client_secret

# 🌍 환경 설정
ENVIRONMENT=production
```

### 4. 보안 키 생성 도구

**JWT Secret 생성:**
```bash
# 방법 1: OpenSSL 사용
openssl rand -base64 32

# 방법 2: Python 사용
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

**강력한 비밀번호 생성:**
```bash
# 방법 1: OpenSSL 사용
openssl rand -base64 16

# 방법 2: 온라인 도구 사용
# https://passwordsgenerator.net/
```

---

## 🚀 배포 실행

### 1. 배포 스크립트 실행 권한 부여
```bash
chmod +x aws-deploy.sh aws-destroy.sh
```

### 2. 배포 전 검증 (선택사항)
```bash
./scripts/pre-deployment-validation.sh
```

### 3. 배포 시작
```bash
./aws-deploy.sh
```

### 4. 배포 과정 모니터링

배포 과정에서 다음 단계들이 자동으로 진행됩니다:

```
🔄 배포 진행 상황:
├── 1. Terraform으로 AWS 인프라 생성 (약 3-5분)
├── 2. 서버 초기화 및 Docker 설치 (약 2-3분)
├── 3. 애플리케이션 파일 복사 (약 1분)
├── 4. SSL 인증서 발급 (약 1-2분)
├── 5. Docker 컨테이너 시작 (약 2-3분)
└── 6. 헬스체크 및 배포 완료 (약 1분)

총 소요시간: 약 10-15분
```

### 5. 배포 완료 확인

배포가 성공하면 다음과 같은 메시지가 표시됩니다:

```
🎉 LifeBit AWS 배포가 완료되었습니다!

═══════════════════════════════════════
         배포 완료 정보
═══════════════════════════════════════
📱 프론트엔드:     http://[서버IP]:3000
🔧 Core API:      http://[서버IP]:8080
🤖 AI API:        http://[서버IP]:8001
🌐 Nginx (통합):  http://[서버IP]

🔑 SSH 접속:
   ssh -i ~/.ssh/lifebit_key ubuntu@[서버IP]

⚠️  DNS 설정 필요:
   도메인 등록업체에서 다음 DNS 레코드를 설정하세요:
   Type: A
   Name: @ (또는 도메인명)
   Value: [서버IP]
   TTL: 300
```

---

## 🌐 DNS 설정 완료

### 1. 가비아 DNS 관리 페이지 접속
1. 가비아 로그인 → "My 가비아" → "도메인 관리"
2. 구매한 도메인 선택 → "DNS 관리" 클릭

### 2. A 레코드 추가/수정
```
레코드 타입: A
호스트명: @ (또는 비워두기)
값/주소: [배포 완료 시 표시된 서버 IP]
TTL: 300 (5분)
```

### 3. DNS 전파 확인
```bash
# DNS 전파 확인
nslookup mylifebit.store

# 또는 온라인 도구 사용
# https://www.whatsmydns.net/
```

---

## ✅ 배포 확인

### 1. 서비스 접속 테스트

**HTTP 접속 (즉시 가능):**
```bash
curl -I http://[서버IP]
```

**도메인 접속 (DNS 전파 후):**
```bash
curl -I http://mylifebit.store
```

### 2. 웹 브라우저 접속
- **임시 접속**: `http://[서버IP]:3000`
- **도메인 접속**: `http://mylifebit.store` (DNS 전파 후)
- **HTTPS 접속**: `https://mylifebit.store` (SSL 인증서 발급 후)

### 3. 서비스 상태 확인

**SSH 접속:**
```bash
ssh -i ~/.ssh/lifebit_key ubuntu@[서버IP]
```

**컨테이너 상태 확인:**
```bash
docker ps
```

**로그 확인:**
```bash
# 전체 로그
docker-compose -f docker-compose.prod.yml logs

# 특정 서비스 로그
docker-compose -f docker-compose.prod.yml logs frontend
docker-compose -f docker-compose.prod.yml logs core-api
docker-compose -f docker-compose.prod.yml logs ai-api
```

---

## 🔧 문제 해결

### 자주 발생하는 문제들

#### 1. DNS 전파 지연
**증상**: 도메인 접속이 안됨
**해결**: 
- DNS 전파는 5분-24시간 소요 가능
- `nslookup` 명령어로 전파 상태 확인
- 임시로 서버 IP로 직접 접속

#### 2. SSL 인증서 발급 실패
**증상**: HTTPS 접속 시 인증서 오류
**해결**:
```bash
# Let's Encrypt 레이트 리밋 확인
# 주당 도메인당 20개 제한
# 실패 시 스테이징 인증서 사용됨 (브라우저 경고 발생)
```

#### 3. 컨테이너 시작 실패
**증상**: 서비스 접속 불가
**해결**:
```bash
# 컨테이너 상태 확인
docker ps -a

# 로그 확인
docker-compose -f docker-compose.prod.yml logs [서비스명]

# 컨테이너 재시작
docker-compose -f docker-compose.prod.yml restart [서비스명]
```

#### 4. 메모리 부족
**증상**: 컨테이너가 자꾸 재시작됨
**해결**:
- AWS 인스턴스 타입 업그레이드 (t3.micro → t3.small)
- `infrastructure/terraform/main.tf`에서 `instance_type` 수정

#### 5. 포트 접근 불가
**증상**: 특정 포트로 접속 안됨
**해결**:
```bash
# 보안 그룹 확인
aws ec2 describe-security-groups --group-names lifebit-security-group

# 방화벽 확인
sudo ufw status
```

### 로그 수집 및 디버깅

**전체 시스템 상태 확인:**
```bash
# 시스템 리소스
htop
df -h

# 네트워크 상태
ss -tlnp

# Docker 상태
docker system df
docker stats
```

---

## 🧹 리소스 정리

### 배포 중단 및 리소스 삭제

⚠️ **주의**: 이 명령어는 모든 AWS 리소스를 삭제합니다!

```bash
./aws-destroy.sh
```

### 선택적 리소스 정리

**컨테이너만 중지:**
```bash
ssh -i ~/.ssh/lifebit_key ubuntu@[서버IP]
cd /home/ubuntu/lifebit
docker-compose -f docker-compose.prod.yml down
```

**특정 컨테이너만 재시작:**
```bash
docker-compose -f docker-compose.prod.yml restart nginx
```

---

## 📞 지원 및 문의

### 문제 신고 시 포함할 정보

1. **환경 정보**
   - 운영체제 및 버전
   - Docker, Terraform, Ansible 버전
   - AWS 리전

2. **오류 로그**
   ```bash
   # 배포 로그 저장
   ./aws-deploy.sh 2>&1 | tee deployment.log
   
   # 컨테이너 로그 저장
   docker-compose -f docker-compose.prod.yml logs > container.log
   ```

3. **설정 파일**
   - `.env` 파일 (민감한 정보 제외)
   - 오류 발생 시점의 스크린샷

### 추가 자료

- **프로젝트 문서**: `docs/` 폴더 내 다른 가이드 참조
- **Docker 공식 문서**: https://docs.docker.com/
- **AWS 공식 문서**: https://docs.aws.amazon.com/
- **Let's Encrypt 문서**: https://letsencrypt.org/docs/

---

## 🎯 배포 성공 체크리스트

배포가 완료되면 다음 항목들을 확인하세요:

- [ ] 모든 Docker 컨테이너가 `healthy` 상태
- [ ] HTTP로 도메인 접속 가능
- [ ] 프론트엔드 페이지 정상 로드
- [ ] API 엔드포인트 응답 확인
- [ ] 데이터베이스 연결 정상
- [ ] SSL 인증서 상태 확인 (스테이징/프로덕션)
- [ ] 로그에 심각한 오류 없음

---

## 🚀 다음 단계

배포가 성공적으로 완료되면:

1. **모니터링 설정**: CloudWatch, 로그 수집 시스템 구축
2. **백업 시스템**: 데이터베이스 자동 백업 설정
3. **CI/CD 파이프라인**: GitHub Actions 등을 통한 자동 배포
4. **성능 최적화**: CDN, 캐싱 시스템 도입
5. **보안 강화**: WAF, 추가 보안 그룹 설정

---

**🎉 축하합니다! LifeBit 프로젝트가 성공적으로 배포되었습니다!**

> 💡 **팁**: 이 가이드를 북마크해두시고, 배포 과정에서 문제가 발생하면 해당 섹션을 참조하세요. 