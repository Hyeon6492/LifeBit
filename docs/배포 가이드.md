# LifeBit 자동화 배포 가이드

이 문서는 LifeBit 프로젝트의 AWS 단일 인스턴스 기반 자동화 배포를 위한 상세한 가이드입니다.

## 📋 목차

1. [사전 요구사항](#사전-요구사항)
2. [환경 설정](#환경-설정)
3. [배포 프로세스](#배포-프로세스)
4. [모니터링 및 유지보수](#모니터링-및-유지보수)
5. [문제 해결](#문제-해결)
6. [비용 최적화](#비용-최적화)

## 🔧 사전 요구사항

### 1. AWS 계정 및 권한

#### AWS 계정 생성
- AWS 계정이 필요합니다 (학원 프로젝트용 무료 티어 권장)
- IAM 사용자 생성 및 권한 설정

#### 필요한 권한
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:*",
                "s3:*",
                "route53:*",
                "iam:GetUser",
                "iam:ListAccessKeys"
            ],
            "Resource": "*"
        }
    ]
}
```

#### AWS CLI 설정
```bash
# AWS CLI 설치
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# AWS 설정
aws configure
```

### 2. 도구 설치

#### Terraform 설치
```bash
# Terraform 설치
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
sudo apt-get update && sudo apt-get install terraform

# 버전 확인
terraform version
```

#### Ansible 설치
```bash
# Ansible 설치
sudo apt-get update
sudo apt-get install software-properties-common
sudo apt-add-repository --yes --update ppa:ansible/ansible
sudo apt-get install ansible

# 버전 확인
ansible --version
```

#### Docker 설치 (로컬 개발용)
```bash
# Docker 설치
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Docker Compose 설치
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. SSH 키페어 생성

```bash
# SSH 키페어 생성
ssh-keygen -t rsa -b 4096 -f ~/.ssh/lifebit-key -N ""

# AWS에 키페어 등록
aws ec2 import-key-pair \
    --key-name lifebit-key \
    --public-key-material fileb://~/.ssh/lifebit-key.pub
```

## 🌍 환경 설정

### 1. 환경 변수 설정

프로젝트 루트에 `.env` 파일을 생성하고 다음 내용을 설정합니다:

```bash
# AWS 설정
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_REGION="ap-northeast-2"

# 서버 설정
export LIFEBIT_SERVER_IP="your-server-ip"  # 배포 후 설정
export AWS_KEY_NAME="lifebit-key"

# 데이터베이스 설정
export DB_PASSWORD="your-secure-password"
export DB_NAME="lifebit_db"
export DB_USER="lifebit_user"

# OpenAI 설정
export OPENAI_API_KEY="your-openai-api-key"

# 소셜 로그인 설정
export KAKAO_CLIENT_ID="your-kakao-client-id"
export GOOGLE_CLIENT_ID="your-google-client-id"

# 도메인 설정 (선택사항)
export DOMAIN_NAME="your-domain.com"

# JWT 설정
export JWT_SECRET="your-jwt-secret-key"
```

### 2. Terraform 변수 설정

`infrastructure/terraform/terraform.tfvars` 파일을 생성합니다:

```hcl
# AWS 설정
aws_region = "ap-northeast-2"
instance_type = "t3.medium"
key_name = "lifebit-key"
volume_size = 20

# 도메인 설정 (선택사항)
domain_name = "your-domain.com"
create_domain = false

# 환경 설정
environment = "production"
project_name = "LifeBit"
```

## 🚀 배포 프로세스

### 1단계: 인프라 프로비저닝

```bash
# 배포 스크립트 실행
./infrastructure/scripts/deploy.sh

# 또는 단계별 실행
./infrastructure/scripts/deploy.sh terraform-only
```

#### Terraform 실행 과정
1. **초기화**: `terraform init`
2. **계획 확인**: `terraform plan`
3. **사용자 확인**: 계속 진행 여부 확인
4. **인프라 생성**: `terraform apply`

#### 생성되는 리소스
- VPC 및 서브넷
- 보안 그룹
- EC2 인스턴스 (t3.medium)
- Elastic IP
- S3 버킷 (Terraform 상태 저장용)

### 2단계: 서버 설정

```bash
# Ansible 배포
./infrastructure/scripts/deploy.sh ansible-only
```

#### Ansible 실행 과정
1. **연결 테스트**: 서버 연결 확인
2. **시스템 설정**: 기본 패키지 설치 및 설정
3. **Docker 설치**: Docker 및 Docker Compose 설치
4. **Nginx 설정**: 리버스 프록시 설정
5. **애플리케이션 배포**: Docker 컨테이너 실행

### 3단계: SSL 인증서 설정 (도메인이 있는 경우)

```bash
# SSL 인증서 설정
./infrastructure/scripts/deploy.sh ssl-only
```

#### SSL 설정 과정
1. **도메인 확인**: Route 53에서 도메인 관리
2. **인증서 발급**: Let's Encrypt를 통한 무료 SSL 인증서
3. **Nginx 설정**: HTTPS 리다이렉트 및 SSL 설정

### 4단계: 헬스 체크

```bash
# 서비스 상태 확인
curl http://your-server-ip/health
curl http://your-server-ip:8080/actuator/health
curl http://your-server-ip:8001/health
```

## 📊 모니터링 및 유지보수

### 1. 시스템 모니터링

#### 자동 모니터링
- **Cron 작업**: 5분마다 시스템 상태 체크
- **로그 모니터링**: 애플리케이션 및 시스템 로그 추적
- **리소스 모니터링**: CPU, 메모리, 디스크 사용량 체크

#### 수동 모니터링
```bash
# 서버 접속
ssh -i ~/.ssh/lifebit-key.pem ubuntu@your-server-ip

# 시스템 상태 확인
/home/ubuntu/monitor.sh

# Docker 컨테이너 상태
docker ps

# 로그 확인
docker logs lifebit_core_api
docker logs lifebit_ai_api
docker logs lifebit_frontend
```

### 2. 백업 관리

#### 자동 백업
- **일일 백업**: 매일 새벽 2시 자동 백업
- **보관 기간**: 7일간 백업 보관
- **백업 내용**: 데이터베이스, 애플리케이션 파일, 설정 파일

#### 수동 백업
```bash
# 서버에서 백업 실행
/opt/lifebit/backup.sh manual_backup_$(date +%Y%m%d_%H%M%S)

# 백업 목록 확인
ls -la /opt/lifebit/backups/
```

### 3. 로그 관리

#### 로그 정리
- **자동 정리**: 매일 새벽 3시 로그 정리
- **보관 기간**: 30일간 로그 보관
- **압축**: 100MB 이상 로그 파일 자동 압축

#### 로그 확인
```bash
# 애플리케이션 로그
tail -f /var/log/lifebit/backup.log
tail -f /var/log/lifebit/health.log

# Nginx 로그
tail -f /var/log/nginx/lifebit_access.log
tail -f /var/log/nginx/lifebit_error.log

# Docker 로그
docker logs -f lifebit_core_api
```

## 🔧 문제 해결

### 1. 일반적인 문제들

#### 서비스가 시작되지 않는 경우
```bash
# 컨테이너 상태 확인
docker ps -a

# 컨테이너 재시작
docker restart lifebit_core_api
docker restart lifebit_ai_api
docker restart lifebit_frontend

# 로그 확인
docker logs lifebit_core_api
```

#### 데이터베이스 연결 실패
```bash
# PostgreSQL 상태 확인
docker exec lifebit_postgres_prod pg_isready -U lifebit_user -d lifebit_db

# 데이터베이스 재시작
docker restart lifebit_postgres_prod

# 연결 테스트
docker exec lifebit_postgres_prod psql -U lifebit_user -d lifebit_db -c "SELECT 1;"
```

#### 메모리 부족
```bash
# 메모리 사용량 확인
free -h

# 스왑 파일 확인
swapon --show

# 불필요한 컨테이너 정리
docker system prune -f
```

### 2. 롤백 절차

#### 자동 롤백
```bash
# 이전 버전으로 롤백
./infrastructure/scripts/rollback.sh

# 특정 버전으로 롤백
./infrastructure/scripts/rollback.sh 20241201_143022
```

#### 수동 롤백
```bash
# 서버 접속
ssh -i ~/.ssh/lifebit-key.pem ubuntu@your-server-ip

# 컨테이너 중지
cd /opt/lifebit
docker-compose -f docker-compose.prod.yml down

# 이전 이미지로 복원
docker image tag lifebit_frontend:previous lifebit_frontend:latest

# 컨테이너 재시작
docker-compose -f docker-compose.prod.yml up -d
```

### 3. 디버깅 도구

#### 시스템 진단
```bash
# 시스템 리소스 확인
htop
df -h
free -h

# 네트워크 연결 확인
netstat -tulpn
ping 8.8.8.8

# 서비스 상태 확인
systemctl status nginx
systemctl status docker
```

#### 애플리케이션 진단
```bash
# API 엔드포인트 테스트
curl -v http://localhost:8080/actuator/health
curl -v http://localhost:8001/health

# 데이터베이스 연결 테스트
docker exec lifebit_postgres_prod psql -U lifebit_user -d lifebit_db -c "SELECT version();"
```

## 💰 비용 최적화

### 1. 인스턴스 최적화

#### 인스턴스 타입 선택
- **t3.medium**: 2 vCPU, 4GB RAM (월 약 $30)
- **t3.small**: 2 vCPU, 2GB RAM (월 약 $15) - 개발용
- **스팟 인스턴스**: 50-70% 절약 가능

#### 스토리지 최적화
- **EBS gp3**: gp2 대비 20% 절약
- **필요한 최소 용량**: 20GB (기본 설정)
- **스냅샷 관리**: 불필요한 스냅샷 삭제

### 2. 네트워크 최적화

#### 데이터 전송 최소화
- **단일 AZ 사용**: 데이터 전송 비용 절약
- **CDN 사용**: 정적 파일 캐싱 (선택사항)
- **압축 활성화**: gzip 압축으로 대역폭 절약

### 3. 모니터링 비용

#### CloudWatch 최적화
- **기본 모니터링만 사용**: 상세 모니터링 비활성화
- **로그 보관 기간**: 30일로 제한
- **메트릭 필터링**: 필요한 메트릭만 수집

### 4. 예상 월 비용

#### 기본 구성 (t3.medium)
- **EC2 인스턴스**: $30
- **EBS 볼륨**: $2
- **데이터 전송**: $1
- **총 예상 비용**: $33/월

#### 최적화 구성 (t3.small)
- **EC2 인스턴스**: $15
- **EBS 볼륨**: $2
- **데이터 전송**: $1
- **총 예상 비용**: $18/월

## 📝 체크리스트

### 배포 전 확인사항
- [ ] AWS 계정 및 권한 설정 완료
- [ ] SSH 키페어 생성 및 등록
- [ ] 환경 변수 설정 완료
- [ ] Terraform 및 Ansible 설치 완료
- [ ] 도메인 설정 (선택사항)
- [ ] 로컬 테스트 완료

### 배포 중 확인사항
- [ ] Terraform 인프라 생성 성공
- [ ] Ansible 서버 설정 완료
- [ ] Docker 컨테이너 실행 확인
- [ ] 데이터베이스 연결 확인
- [ ] SSL 인증서 적용 확인 (도메인 있는 경우)

### 배포 후 확인사항
- [ ] 웹사이트 접속 확인
- [ ] API 엔드포인트 테스트
- [ ] 데이터베이스 연결 테스트
- [ ] 로그 모니터링 설정
- [ ] 백업 스케줄 설정
- [ ] 헬스 체크 정상 작동 확인

## 🆘 지원 및 연락처

### 문제 발생 시
1. **로그 확인**: `/var/log/lifebit/` 디렉토리 확인
2. **헬스 체크**: `/opt/lifebit/health-check.sh` 실행
3. **백업 확인**: `/opt/lifebit/backup.sh` 실행
4. **문서 참조**: 이 가이드 및 README.md 확인

### 추가 지원
- **프로젝트 리더**: [이름]
- **기술 문의**: [이메일]
- **문서**: [위키 링크]

---

**주의사항**: 이 배포 가이드는 학원 프로젝트용으로 작성되었으며, 프로덕션 환경에서는 추가적인 보안 및 성능 최적화가 필요할 수 있습니다. 