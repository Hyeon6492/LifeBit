# 🚀 LifeBit 자동 배포 설정 가이드

안녕하세요! 우리가 만든 멋진 LifeBit 프로젝트를 AWS에 자동으로 배포하는 방법을 안내해드릴게요.

이제 `aws-deploy.sh` 스크립트를 사용해서 로컬에서 직접 배포할 수 있습니다. 키페어도 자동으로 생성되니까 정말 간편해요!

## 📋 사전 요구사항

배포를 시작하기 전에 다음 도구들이 설치되어 있어야 합니다:

### 1️⃣ 필수 도구 설치

#### AWS CLI 설치 및 설정
```bash
# AWS CLI 설치 (Ubuntu/Debian)
sudo apt update
sudo apt install awscli

# AWS CLI 설치 (macOS)
brew install awscli

# AWS CLI 설치 (Windows)
# https://aws.amazon.com/cli/ 에서 다운로드

# AWS 자격 증명 설정
aws configure
# AWS Access Key ID: [여러분의 액세스 키]
# AWS Secret Access Key: [여러분의 시크릿 키]
# Default region name: ap-northeast-2
# Default output format: json
```

#### Terraform 설치
```bash
# Terraform 설치 (Ubuntu/Debian)
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform

# Terraform 설치 (macOS)
brew tap hashicorp/tap
brew install hashicorp/tap/terraform

# Terraform 설치 (Windows)
# https://developer.hashicorp.com/terraform/downloads 에서 다운로드
```

#### Ansible 설치
```bash
# Ansible 설치 (Ubuntu/Debian)
sudo apt update
sudo apt install ansible

# Ansible 설치 (macOS)
brew install ansible

# Ansible 설치 (Windows)
# WSL을 통해 설치하거나 https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html 참고
```

### 2️⃣ 환경 변수 설정

프로젝트 루트에 `.env` 파일을 생성하고 필요한 값들을 설정합니다:

```bash
# .env.example을 복사
cp .env.example .env

# .env 파일 편집
nano .env
```

`.env` 파일에 다음 내용을 추가하세요:

```env
# AWS 자격 증명 (aws configure로 설정했다면 비워둬도 됩니다)
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here

# Docker Compose를 위한 애플리케이션 비밀 값들
OPENAI_API_KEY=sk-your_openai_api_key_here
JWT_SECRET_KEY=your_jwt_secret_key_here
GOOGLE_CLIENT_SECRET=your_google_client_secret_here
KAKAO_CLIENT_ID=your_kakao_client_id_here
GOOGLE_CLIENT_ID=your_google_client_id_here
```

> 🎉 **좋은 소식!** 키페어는 자동으로 생성됩니다. `SSH_PRIVATE_KEY_PATH` 설정이 필요 없어요!

## 🚀 배포 실행

### 배포하기

모든 준비가 완료되면 다음 명령어로 배포를 시작할 수 있습니다:

```bash
# 배포 실행
./aws-deploy.sh deploy
```

배포 과정은 다음과 같습니다:

1. **키페어 생성** - 고유한 키페어를 자동으로 생성합니다
2. **Terraform 실행** - AWS 인프라를 프로비저닝합니다
3. **Ansible 인벤토리 업데이트** - 서버 정보를 Ansible에 전달합니다
4. **SSH 연결 대기** - 서버가 준비될 때까지 대기합니다
5. **Ansible 플레이북 실행** - 서버 설정 및 애플리케이션 배포
6. **배포 정보 저장** - 키페어 정보와 서버 IP를 저장합니다

### 배포 완료 후

배포가 성공적으로 완료되면 다음과 같은 정보가 출력됩니다:

```
--- 배포 완료 ---
애플리케이션은 http://[서버IP] 에서 확인할 수 있습니다.
키페어 정보: lifebit-key-20241201-143022
키 파일 경로: /home/user/.ssh/lifebit-key-20241201-143022.pem
```

### 리소스 삭제하기

서버를 더 이상 사용하지 않을 때는 다음 명령어로 모든 리소스를 삭제할 수 있습니다:

```bash
# 모든 리소스 삭제 (키페어 포함)
./aws-deploy.sh destroy
```

삭제 과정:
1. **AWS 리소스 삭제** - EC2, 보안 그룹, VPC 등 모든 AWS 리소스 삭제
2. **키페어 정리** - AWS 키페어와 로컬 파일 삭제
3. **배포 정보 정리** - `.deployment_info` 파일 삭제

> 💰 **비용 절약 팁!** 사용하지 않을 때는 반드시 `destroy`를 실행해서 서버를 삭제하세요. 그렇지 않으면 계속 요금이 발생합니다!

## 🔧 문제 해결

### SSH 연결 실패

SSH 연결이 실패하는 경우 다음을 확인해보세요:

1. **보안 그룹 설정** - 포트 22가 현재 IP에서 열려있는지 확인
2. **키 파일 권한** - 키 파일 권한이 600인지 확인
3. **서버 상태** - EC2 인스턴스가 실행 중인지 확인

```bash
# 키 파일 권한 확인 및 수정
ls -la ~/.ssh/lifebit-key-*.pem
chmod 600 ~/.ssh/lifebit-key-*.pem

# 서버 상태 확인
aws ec2 describe-instances --filters "Name=tag:Name,Values=lifebit-server" --query 'Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress]' --output table
```

### Terraform 오류

Terraform 실행 중 오류가 발생하는 경우:

```bash
# Terraform 상태 확인
cd infrastructure/terraform
terraform plan

# Terraform 초기화 재실행
terraform init -reconfigure
```

### Ansible 오류

Ansible 실행 중 오류가 발생하는 경우:

```bash
# Ansible 연결 테스트
ansible all -i infrastructure/ansible/inventory -m ping

# 상세 로그로 실행
ansible-playbook -i infrastructure/ansible/inventory infrastructure/ansible/playbook.yml -vvv
```

## 📊 배포 정보 확인

배포 후 생성되는 `.deployment_info` 파일에서 배포 정보를 확인할 수 있습니다:

```bash
# 배포 정보 확인
cat .deployment_info
```

출력 예시:
```
KEY_PAIR_NAME=lifebit-key-20241201-143022
SSH_PRIVATE_KEY_PATH=/home/user/.ssh/lifebit-key-20241201-143022.pem
INSTANCE_IP=3.34.123.45
DEPLOYMENT_DATE=Sat Dec 1 14:30:22 KST 2024
```

## 🎯 주요 특징

### ✅ 자동화된 키페어 관리
- 배포 시 자동으로 고유한 키페어 생성
- 삭제 시 키페어와 키 파일 자동 정리
- 키 파일 권한 자동 설정

### ✅ 완전한 리소스 정리
- `destroy` 실행 시 모든 AWS 리소스 삭제
- 키페어, 로컬 파일, 배포 정보 완전 정리
- 비용 발생 방지

### ✅ 배포 정보 추적
- 키페어 이름, 서버 IP, 배포 날짜 기록
- 다음 배포 시 참조 가능
- 문제 발생 시 디버깅 정보 제공

## 🚨 주의사항

1. **비용 관리** - 사용하지 않을 때는 반드시 `destroy` 실행
2. **키 파일 보안** - 생성된 키 파일은 안전하게 보관
3. **환경 변수** - `.env` 파일의 민감한 정보는 절대 공유하지 마세요
4. **백업** - 중요한 데이터는 별도로 백업하세요

---

**이제 모든 준비가 끝났습니다! `./aws-deploy.sh deploy` 명령어로 배포를 시작해보세요! 🚀** 